<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€Ÿè®°å¤§å¸ˆ - Quick Recall</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è®¾ç½® Inter å­—ä½“ä½œä¸ºé¦–é€‰ */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸å†…å®¹æ»šåŠ¨ */
        body {
            overflow-y: scroll;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        /* å…³é”®å¸§åŠ¨ç”»ï¼šé—ªçƒæ•ˆæœ */
        @keyframes flash {
            0%, 100% { background-color: #6366f1; } /* Indigo 500 */
            50% { background-color: #a5b4fc; } /* Indigo 300 */
        }
        .flash-animation {
            animation: flash 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div id="game-container" class="w-full max-w-xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 border-t-8 border-indigo-600 transform transition-all duration-300 mb-6">
        
        <!-- æ¸¸æˆæ ‡é¢˜å’ŒçŠ¶æ€ -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-indigo-800 mb-2">é€Ÿè®°å¤§å¸ˆ ğŸ§ </h1>
            <p class="text-gray-600 text-sm">è®°ä½é¡ºåºï¼Œç„¶åå¿«é€Ÿç‚¹å‡»ï¼</p>
        </header>

        <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
        <div class="flex justify-between items-center mb-6 text-gray-700 font-semibold text-lg">
            <div class="flex items-center space-x-2">
                <span class="text-indigo-600">ğŸ† ç­‰çº§:</span>
                <span id="level-display" class="text-xl text-indigo-800">1</span>
            </div>
            <div class="flex items-center space-x-2">
                <span class="text-indigo-600">ğŸ•°ï¸ è®¡æ—¶:</span>
                <span id="timer-display" class="text-xl text-indigo-800">0s</span>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»åŒºåŸŸï¼šåºåˆ—æ˜¾ç¤ºå’Œæç¤ºä¿¡æ¯ -->
        <div id="main-area" class="min-h-[150px] flex flex-col items-center justify-center p-4 bg-indigo-50 rounded-lg border-2 border-dashed border-indigo-300 mb-6 transition-all duration-300">
            <div id="sequence-display" class="flex flex-wrap justify-center gap-3 text-6xl font-bold transition-opacity duration-500 opacity-0">
                <!-- è®°å¿†åºåˆ—æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
            <p id="message-text" class="text-center text-xl font-medium text-gray-800 transition-opacity duration-300">ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€æŒ‘æˆ˜ä½ çš„è®°å¿†åŠ›ï¼</p>
            <p id="instructions" class="text-center text-sm text-gray-500 mt-2 hidden">ç‚¹å‡»ä¸‹æ–¹çš„å›¾æ ‡ï¼ŒæŒ‰ç…§ä½ åˆšæ‰çœ‹åˆ°çš„é¡ºåºè¾“å…¥ã€‚</p>
        </div>

        <!-- è¾“å…¥æŒ‰é’®åŒºåŸŸ -->
        <div id="input-buttons" class="grid grid-cols-4 gap-3 mb-6">
            <!-- åŠ¨æ€ç”Ÿæˆçš„è¾“å…¥æŒ‰é’®åœ¨è¿™é‡Œ -->
        </div>

        <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
        <div class="flex flexcol space-y-3">
            <button id="start-button" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01] focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50">
                å¼€å§‹æ¸¸æˆ
            </button>
            <button id="status-message" class="w-full py-3 px-4 bg-gray-300 text-gray-700 font-bold rounded-lg cursor-default hidden">
                è®°å¿†ä¸­...
            </button>
        </div>
        
        <!-- å½“å‰ç”¨æˆ· ID æ˜¾ç¤º -->
        <p class="text-xs text-gray-400 text-right mt-3">
            ä½ çš„ç”¨æˆ·ID (ç”¨äºåˆ†äº«): 
            <span id="user-id-display" class="font-mono text-gray-600">åŠ è½½ä¸­...</span>
        </p>

        <!-- æ¸¸æˆç»“æŸ/é«˜åˆ†è®°å½•åŒºåŸŸ -->
        <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                <h3 class="text-3xl font-extrabold text-red-600 mb-3">æ¸¸æˆç»“æŸ âŒ</h3>
                <p class="text-lg text-gray-700 mb-4">ä½ çš„æœ€ç»ˆç­‰çº§æ˜¯: <span id="final-level" class="text-indigo-600 font-bold text-2xl">1</span></p>
                <div id="high-score-message" class="text-sm font-medium text-green-600 bg-green-50 p-2 rounded hidden mb-4">
                    ğŸ‰ æ–°çºªå½•å·²ä¿å­˜åˆ°æ’è¡Œæ¦œ!
                </div>
                <button id="restart-button" class="w-full py-3 px-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        </div>
    </div>
    
    <!-- å…¨çƒæ’è¡Œæ¦œåŒºåŸŸ -->
    <div id="leaderboard-container" class="w-full max-w-xl bg-white shadow-xl rounded-xl p-6 sm:p-8 border-b-8 border-indigo-600">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4 text-center">ğŸ† å…¨çƒæ’è¡Œæ¦œ (Top 10)</h2>
        <div class="space-y-2" id="leaderboard-list">
            <p class="text-center text-gray-500">æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...</p>
        </div>
    </div>


    <script type="module">
        // Firebase æ¨¡å—å¯¼å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, limit, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables and app ID
        let app;
        let db;
        let auth;
        let userId = 'loading...';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // è§£æå…¨å±€é…ç½®
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Firestore é›†åˆè·¯å¾„
        // è¿™æ˜¯æ’è¡Œæ¦œæ•°æ®å­˜å‚¨çš„å…¬å…±è·¯å¾„ã€‚
        // å¦‚éœ€ä¿®æ”¹ï¼Œè¯·æ›´æ”¹æœ€åçš„ 'highScores' ä¸ºæ‚¨æƒ³è¦çš„æ–°åç§°ï¼ˆä¾‹å¦‚ 'gameLeaderboard'ï¼‰ã€‚
        // è·¯å¾„æ ¼å¼å¿…é¡»æ˜¯ï¼š/artifacts/{appId}/public/data/{æ‚¨çš„é›†åˆåç§°}
        const HIGH_SCORES_COLLECTION = `/artifacts/${appId}/public/data/highScores`;


        // Game Constants
        const EMOJIS = ['ğŸš€', 'ğŸŒŸ', 'ğŸ’¡', 'ğŸ§©', 'ğŸ', 'âš½', 'â°', 'ğŸ¤', 'ğŸŒˆ', 'ğŸŒ™', 'ğŸ”¥', 'ğŸ’§'];
        const MAX_SEQUENCE_LENGTH = EMOJIS.length;
        const INITIAL_SEQUENCE_LENGTH = 3;
        const INITIAL_DISPLAY_TIME = 2000; // 2 seconds
        const RECALL_TIME_LIMIT = 5000; // 5 seconds to answer

        // DOM Elements
        const $startButton = document.getElementById('start-button');
        const $statusMessage = document.getElementById('status-message');
        const $sequenceDisplay = document.getElementById('sequence-display');
        const $messageText = document.getElementById('message-text');
        const $instructions = document.getElementById('instructions');
        const $inputButtons = document.getElementById('input-buttons');
        const $levelDisplay = document.getElementById('level-display');
        const $timerDisplay = document.getElementById('timer-display');
        const $gameOverModal = document.getElementById('game-over-modal');
        const $modalContent = document.getElementById('modal-content');
        const $restartButton = document.getElementById('restart-button');
        const $finalLevel = document.getElementById('final-level');
        const $highScoreMessage = document.getElementById('high-score-message');
        const $userIdDisplay = document.getElementById('user-id-display');
        const $leaderboardList = document.getElementById('leaderboard-list');


        // Game State
        let gameState = {
            level: 1,
            score: 0,
            sequenceLength: INITIAL_SEQUENCE_LENGTH,
            displayTime: INITIAL_DISPLAY_TIME,
            sequence: [],
            playerInput: [],
            recallTimer: null,
            timerInterval: null,
            timeRemaining: RECALL_TIME_LIMIT / 1000,
            isGameRunning: false,
        };

        // --- Utility Functions ---

        /**
         * Generates a unique random sequence of elements.
         * @param {number} length The length of the sequence.
         * @returns {string[]} The generated sequence.
         */
        function generateSequence(length) {
            // éšæœºé€‰å–ç”¨äºæœ¬è½®çš„ N ä¸ªå”¯ä¸€å…ƒç´ 
            const uniqueEmojis = [...EMOJIS].sort(() => 0.5 - Math.random()).slice(0, Math.min(length, MAX_SEQUENCE_LENGTH));
            
            // ä»è¿™ N ä¸ªå…ƒç´ ä¸­ï¼Œéšæœºç”Ÿæˆé•¿åº¦ä¸º L çš„åºåˆ— (å…è®¸é‡å¤)
            const sequence = [];
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * uniqueEmojis.length);
                sequence.push(uniqueEmojis[randomIndex]);
            }
            return sequence;
        }

        /**
         * Renders the input buttons based on the unique elements in the current sequence.
         */
        function renderInputButtons(sequence) {
            $inputButtons.innerHTML = '';
            // è·å–åºåˆ—ä¸­æ‰€æœ‰å”¯ä¸€çš„å…ƒç´ ï¼Œå¹¶éšæœºæ‰“ä¹±å®ƒä»¬çš„é¡ºåº
            const uniqueEmojis = Array.from(new Set(sequence)).sort(() => 0.5 - Math.random());
            
            $inputButtons.style.gridTemplateColumns = `repeat(${uniqueEmojis.length}, minmax(0, 1fr))`;

            uniqueEmojis.forEach(emoji => {
                const button = document.createElement('button');
                button.textContent = emoji;
                button.className = 'py-3 text-4xl bg-gray-200 rounded-lg shadow-md transition duration-150 transform hover:scale-[1.05] hover:bg-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed';
                button.setAttribute('data-value', emoji);
                button.onclick = handleInput;
                button.disabled = true; // é»˜è®¤ç¦ç”¨
                $inputButtons.appendChild(button);
            });
        }

        /**
         * Updates the UI elements to reflect the current game state.
         */
        function updateUI() {
            $levelDisplay.textContent = gameState.level;
            $timerDisplay.textContent = `${gameState.timeRemaining.toFixed(1)}s`;
            $userIdDisplay.textContent = userId;
        }

        /**
         * Enables or disables all input buttons.
         * @param {boolean} enable True to enable, false to disable.
         */
        function toggleInputButtons(enable) {
            const buttons = $inputButtons.querySelectorAll('button');
            buttons.forEach(button => {
                button.disabled = !enable;
                if (enable) {
                    button.classList.remove('bg-gray-300');
                    button.classList.add('bg-indigo-200', 'hover:bg-indigo-300');
                } else {
                    button.classList.add('bg-gray-300');
                    button.classList.remove('bg-indigo-200', 'hover:bg-indigo-300');
                }
            });
        }
        
        /**
         * Fix: ä¿®å¤ Firestore å¤åˆç´¢å¼•é”™è¯¯ï¼Œå®ç°å®¢æˆ·ç«¯æ’è¡Œæ¦œæ’åºã€‚
         * åœ¨å®¢æˆ·ç«¯å¯¹æ’è¡Œæ¦œæ•°æ®è¿›è¡Œæ’åºå’Œé™åˆ¶ã€‚
         * @param {Array<Object>} scores åŸå§‹åˆ†æ•°æ•°æ®åˆ—è¡¨ã€‚
         * @returns {Array<Object>} æ’åºåçš„å‰ 10 æ¡è®°å½•ã€‚
         */
        function sortAndLimitLeaderboard(scores) {
            // æ’åºé€»è¾‘ï¼š
            // 1. Level é™åº (ç­‰çº§è¶Šé«˜è¶Šå¥½)
            // 2. Timestamp å‡åº (ç­‰çº§ç›¸åŒæ—¶ï¼Œæ—¶é—´è¶Šæ—©è¶Šå¥½)
            scores.sort((a, b) => {
                // 1. Level is the primary sort (Descending)
                if (a.level !== b.level) {
                    return b.level - a.level;
                }
                // 2. Timestamp is the secondary sort (Ascending: Earlier time is better)
                // å¿…é¡»æ£€æŸ¥ timestamp æ˜¯å¦å­˜åœ¨ï¼Œä»¥é˜²å°šæœªå†™å…¥ï¼ˆè™½ç„¶ä¸å¤ªå¯èƒ½åœ¨ onSnapshot ä¸­å‘ç”Ÿï¼‰
                const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                return timeA - timeB;
            });

            // é™åˆ¶ä¸ºå‰ 10 æ¡
            return scores.slice(0, 10);
        }


        // --- Firebase Functions ---

        /**
         * åˆå§‹åŒ– Firebase åº”ç”¨å’Œè®¤è¯ã€‚
         */
        async function firebaseSetup() {
            try {
                // 1. åˆå§‹åŒ– Firebase æ ¸å¿ƒæœåŠ¡
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. å°è¯•ä½¿ç”¨è‡ªå®šä¹‰ä»¤ç‰Œæˆ–åŒ¿åç™»å½•
                let userAuthenticated = false;
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    userAuthenticated = true;
                } else {
                    await signInAnonymously(auth);
                    userAuthenticated = true;
                }
                
                // 3. ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆç¡®ä¿ userId æ˜¯æœ€æ–°çš„ï¼‰
                onAuthStateChanged(auth, (user) => {
                    if (user && db) {
                        userId = user.uid;
                        updateUI();
                        // è®¤è¯æˆåŠŸä¸” db å‡†å¤‡å°±ç»ªåï¼ŒåŠ è½½æ’è¡Œæ¦œ
                        loadLeaderboard();
                    } else if (db) {
                        // å¦‚æœæ— æ³•è·å–ç”¨æˆ·ï¼Œä½¿ç”¨é»˜è®¤ IDï¼Œå¹¶å°è¯•åŠ è½½æ’è¡Œæ¦œ (è™½ç„¶å¯èƒ½ä¼šå¤±è´¥)
                        userId = 'guest-' + crypto.randomUUID().substring(0, 8);
                        updateUI();
                        loadLeaderboard();
                    } else {
                        // å¦‚æœ db æœªå‡†å¤‡å¥½
                        $userIdDisplay.textContent = 'Auth Ready, DB Error';
                        $leaderboardList.innerHTML = '<p class="text-center text-red-500">æ— æ³•è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡ã€‚</p>';
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–è®¤è¯å¤±è´¥:", error);
                $userIdDisplay.textContent = 'é”™è¯¯!';
                $leaderboardList.innerHTML = '<p class="text-center text-red-500">æ’è¡Œæ¦œåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚</p>';
            }
        }

        /**
         * ä» Firestore åŠ è½½å¹¶å®æ—¶ç›‘å¬å…¨çƒæ’è¡Œæ¦œã€‚
         */
        function loadLeaderboard() {
            if (!db) {
                console.error("loadLeaderboard: Firestore æ•°æ®åº“å®ä¾‹ç¼ºå¤±.");
                $leaderboardList.innerHTML = '<p class="text-center text-red-500">æ— æ³•è¿æ¥åˆ°æ’è¡Œæ¦œæœåŠ¡ã€‚</p>';
                return;
            }

            // FIX: ç®€åŒ–æŸ¥è¯¢ä»¥é¿å…å¤åˆç´¢å¼•é”™è¯¯ã€‚åªæŒ‰ level é™åºæ’åˆ—ã€‚
            // å¿…é¡»ç§»é™¤ limit(10)ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦è·å–æ‰€æœ‰æ•°æ®ä»¥ä¾¿åœ¨å®¢æˆ·ç«¯æ’åºå’Œç­›é€‰ã€‚
            const q = query(
                collection(db, HIGH_SCORES_COLLECTION),
                orderBy("level", "desc") // åªä¿ç•™ä¸€ä¸ª orderBy
                // orderBy("timestamp", "asc"), // ç§»é™¤ï¼Œé¿å…ç´¢å¼•é”™è¯¯
                // limit(10) // ç§»é™¤ï¼Œåœ¨å®¢æˆ·ç«¯è¿›è¡Œé™åˆ¶
            );

            // å®æ—¶ç›‘å¬
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const rawScores = [];
                snapshot.forEach((doc) => {
                    // ç¡®ä¿ level æ˜¯æ•°å­—ç±»å‹ä»¥ä¾¿æ­£ç¡®æ’åº
                    const data = doc.data();
                    rawScores.push({ ...data, level: Number(data.level) });
                });
                
                // FIX: åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ’åºå’Œé™åˆ¶
                const sortedAndLimitedScores = sortAndLimitLeaderboard(rawScores);

                let html = '';
                if (sortedAndLimitedScores.length === 0) {
                    html = '<p class="text-center text-gray-500">æš‚æ— è®°å½•ï¼Œå¿«æ¥åˆ›é€ ç¬¬ä¸€ä¸ªé«˜åˆ†ï¼</p>';
                } else {
                    sortedAndLimitedScores.forEach((scoreData, index) => {
                        const rank = index + 1;
                        const isCurrentUser = scoreData.userId === userId;
                        const bgColor = isCurrentUser ? 'bg-indigo-100 font-bold' : 'bg-gray-50';
                        // ä½¿ç”¨ toLocaleString ä»¥æ›´å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºæ—¥æœŸ
                        const time = scoreData.timestamp ? new Date(scoreData.timestamp.toDate()).toLocaleString() : 'N/A';
                        
                        // é™åˆ¶ç”¨æˆ·IDé•¿åº¦ï¼Œé˜²æ­¢UIæº¢å‡º
                        const displayUserId = scoreData.userId.substring(0, 10) + '...';

                        html += `
                            <div class="flex justify-between items-center p-3 rounded-lg shadow-sm ${bgColor} transition duration-150 border-l-4 border-indigo-400">
                                <div class="flex items-center space-x-3">
                                    <span class="text-xl w-6 text-center text-indigo-700">${rank}.</span>
                                    <span class="text-gray-900">${scoreData.level} çº§</span>
                                    ${isCurrentUser ? '<span class="text-xs text-indigo-600 bg-indigo-200 px-1 rounded">æˆ‘</span>' : ''}
                                </div>
                                <div class="text-sm text-right">
                                    <p class="text-gray-600 font-mono">${displayUserId}</p>
                                    <p class="text-gray-400 text-xs">${time}</p>
                                </div>
                            </div>
                        `;
                    });
                }
                $leaderboardList.innerHTML = html;
            }, (error) => {
                console.error("åŠ è½½æ’è¡Œæ¦œå¤±è´¥:", error);
                // è¿™é‡Œæ˜¯æ•è·å®‰å…¨è§„åˆ™é”™è¯¯çš„å…³é”®ç‚¹
                $leaderboardList.innerHTML = '<p class="text-center text-red-500">æ’è¡Œæ¦œåŠ è½½å¤±è´¥ï¼è¯·å°è¯•åˆ·æ–°æˆ–æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰æƒé™é”™è¯¯ã€‚</p>';
                unsubscribe(); // åœæ­¢ç›‘å¬ä»¥é˜²æ­¢é‡å¤æŠ¥é”™
            });
        }
        
        /**
         * å°†æ–°çš„é«˜åˆ†ä¿å­˜åˆ° Firestoreã€‚
         * @param {number} level è¾¾åˆ°çš„ç­‰çº§ã€‚
         */
        async function saveHighScore(level) {
            if (!db || !userId) {
                console.error("æ•°æ®åº“æœªåˆå§‹åŒ–æˆ–ç”¨æˆ·IDç¼ºå¤±ï¼Œæ— æ³•ä¿å­˜é«˜åˆ†ã€‚");
                return;
            }
            
            // åˆ›å»ºåˆ†æ•°å¯¹è±¡
            const scoreData = {
                userId: userId,
                level: level,
                timestamp: serverTimestamp() // ä½¿ç”¨ Firestore æœåŠ¡å™¨æ—¶é—´æˆ³
            };

            try {
                // å°†åˆ†æ•°æ·»åŠ åˆ°å…¬å…±é«˜åˆ†é›†åˆ
                await addDoc(collection(db, HIGH_SCORES_COLLECTION), scoreData);
                console.log(`é«˜åˆ† (Level ${level}) å·²æˆåŠŸä¿å­˜åˆ° Firestore.`);
            } catch (error) {
                console.error("ä¿å­˜é«˜åˆ†åˆ° Firestore å¤±è´¥:", error);
                $highScoreMessage.textContent = 'ä¿å­˜é«˜åˆ†å¤±è´¥ï¼';
                $highScoreMessage.classList.remove('hidden', 'text-green-600');
                $highScoreMessage.classList.add('text-red-600');
            }
        }


        // --- Game Flow Functions ---

        /**
         * Starts a new game or a new round.
         */
        function startGame() {
            if (gameState.isGameRunning) return;
            gameState.isGameRunning = true;

            // éšè—å¼€å§‹æŒ‰é’®ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            $startButton.classList.add('hidden');
            $statusMessage.classList.remove('hidden');
            $statusMessage.textContent = 'ç”Ÿæˆåºåˆ—...';
            $messageText.textContent = 'å‡†å¤‡...';
            $instructions.classList.add('hidden');

            // åˆå§‹åŒ–æœ¬è½®çŠ¶æ€
            gameState.playerInput = [];
            gameState.sequence = generateSequence(gameState.sequenceLength);
            
            // æ¸²æŸ“è¾“å…¥æŒ‰é’® (ä½†æš‚ä¸å¯ç”¨)
            renderInputButtons(gameState.sequence);
            toggleInputButtons(false);
            
            // å¼€å§‹è®°å¿†é˜¶æ®µ
            setTimeout(memorizePhase, 1000); // 1ç§’å‡†å¤‡æ—¶é—´
        }

        /**
         * Phase 1: Display the sequence for memorization.
         */
        function memorizePhase() {
            $statusMessage.textContent = 'è®°å¿†ä¸­...';
            $messageText.textContent = `è®°ä½è¿™ä¸ª ${gameState.sequence.length} ä¸ªå…ƒç´ çš„åºåˆ—ï¼`;

            // æ˜¾ç¤ºåºåˆ—
            $sequenceDisplay.innerHTML = gameState.sequence.map(emoji => 
                `<span class="p-2 sm:p-3 bg-indigo-200 rounded-lg shadow-inner">${emoji}</span>`
            ).join('');
            
            // æ¸å…¥æ˜¾ç¤º
            $sequenceDisplay.classList.remove('opacity-0');
            $sequenceDisplay.classList.add('opacity-100');

            // è®°å¿†æ—¶é—´ç»“æŸåï¼Œå¼€å§‹å¬å›é˜¶æ®µ
            setTimeout(() => {
                $sequenceDisplay.classList.remove('opacity-100');
                $sequenceDisplay.classList.add('opacity-0');

                // åºåˆ—æ·¡å‡ºåï¼Œå¼€å§‹å¬å›é˜¶æ®µ
                setTimeout(recallPhase, 500); // 500ms ç­‰å¾…åºåˆ—å®Œå…¨æ·¡å‡º
            }, gameState.displayTime);
        }

        /**
         * Phase 2: User inputs the remembered sequence.
         */
        function recallPhase() {
            $statusMessage.textContent = 'ä½ çš„å›åˆï¼';
            $statusMessage.classList.add('flash-animation');
            $messageText.textContent = 'è¯·æŒ‰ç…§é¡ºåºç‚¹å‡»å›¾æ ‡ã€‚';
            $instructions.classList.remove('hidden');

            toggleInputButtons(true);

            // å¯åŠ¨å¬å›è®¡æ—¶å™¨
            gameState.timeRemaining = RECALL_TIME_LIMIT / 1000;
            updateUI();

            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining -= 0.1;
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timerInterval);
                    handleValidation(false, "è¶…æ—¶äº†ï¼");
                }
                // ç¡®ä¿æ—¶é—´ä¸ä¸ºè´Ÿ
                gameState.timeRemaining = Math.max(0, gameState.timeRemaining);
                updateUI();
            }, 100);
        }

        /**
         * Handles user input from the button clicks.
         * @param {Event} event The click event.
         */
        function handleInput(event) {
            if (gameState.playerInput.length >= gameState.sequence.length) return;

            const input = event.target.getAttribute('data-value');
            gameState.playerInput.push(input);

            // è§†è§‰åé¦ˆï¼šæ ‡è®°å·²ç‚¹å‡»çš„æŒ‰é’®
            event.target.classList.remove('bg-indigo-200', 'hover:bg-indigo-300');
            event.target.classList.add('bg-indigo-600', 'text-white');

            // æ£€æŸ¥æ˜¯å¦è¾“å…¥å®Œæˆ
            if (gameState.playerInput.length === gameState.sequence.length) {
                // åœæ­¢è®¡æ—¶å™¨
                clearInterval(gameState.timerInterval);
                
                const isCorrect = gameState.playerInput.join('') === gameState.sequence.join('');
                handleValidation(isCorrect);
            }
        }

        /**
         * Validates the result and proceeds to the next level or game over.
         * @param {boolean} isCorrect True if the sequence is correct.
         * @param {string} reason Optional reason for failure (e.g., "Timeout").
         */
        function handleValidation(isCorrect, reason = "é¡ºåºé”™è¯¯!") {
            gameState.isGameRunning = false;
            $statusMessage.classList.remove('flash-animation');
            toggleInputButtons(false);

            if (isCorrect) {
                $messageText.textContent = 'âœ… æ­å–œï¼é¡ºåºå®Œå…¨æ­£ç¡®ï¼';
                $messageText.classList.add('text-green-600');
                
                // å»¶è¿Ÿè¿›å…¥ä¸‹ä¸€è½®
                setTimeout(levelUp, 1500);
            } else {
                $messageText.textContent = `âŒ ${reason} æ­£ç¡®åºåˆ—æ˜¯: ${gameState.sequence.join(', ')}`;
                $messageText.classList.add('text-red-600');
                
                // æ¸¸æˆç»“æŸ
                setTimeout(gameOver, 2000);
            }
        }

        /**
         * Moves the game to the next level, increasing difficulty.
         */
        function levelUp() {
            $messageText.classList.remove('text-green-600', 'text-red-600');

            gameState.level++;
            // å¢åŠ åºåˆ—é•¿åº¦ï¼Œä½†ä¸èƒ½è¶…è¿‡æœ€å¤§é™åˆ¶
            gameState.sequenceLength = Math.min(MAX_SEQUENCE_LENGTH, gameState.sequenceLength + 1);
            
            // ç¨å¾®å‡å°‘æ˜¾ç¤ºæ—¶é—´ï¼Œå¢åŠ æŒ‘æˆ˜æ€§ (æœ€å°1ç§’)
            gameState.displayTime = Math.max(1000, gameState.displayTime - 100);

            // é‡ç½®UIå’ŒçŠ¶æ€ï¼Œå¼€å§‹ä¸‹ä¸€è½®
            $statusMessage.classList.add('hidden');
            $startButton.classList.remove('hidden');
            $startButton.textContent = `è¿›å…¥ç­‰çº§ ${gameState.level} (åºåˆ—é•¿åº¦: ${gameState.sequenceLength})`;
            $messageText.textContent = 'å‡†å¤‡å¥½äº†å—ï¼Ÿç‚¹å‡»å¼€å§‹ï¼';
            updateUI();
        }

        /**
         * Handles the end of the game, showing the final score/level.
         */
        async function gameOver() {
            $messageText.classList.remove('text-green-600', 'text-red-600');

            const finalLevel = gameState.level;
            $finalLevel.textContent = finalLevel;

            // æ¸¸æˆç»“æŸåï¼Œä¿å­˜åˆ†æ•°åˆ° Firestore
            // æ³¨æ„ï¼šæˆ‘ä»¬åªä¿å­˜è¾¾åˆ°æ–°ç­‰çº§çš„è®°å½•ï¼Œè€Œä¸æ˜¯æ£€æŸ¥æ˜¯å¦æ˜¯"ä¸ªäººæœ€é«˜åˆ†"
            // æ’è¡Œæ¦œå°†æ ¹æ®æ‰€æœ‰ä¿å­˜çš„è®°å½•è‡ªåŠ¨æ’åº
            if (finalLevel > 1) {
                $highScoreMessage.classList.remove('hidden');
                await saveHighScore(finalLevel);
            } else {
                 $highScoreMessage.classList.add('hidden');
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¨¡æ€æ¡†
            $gameOverModal.classList.remove('hidden');
            $gameOverModal.classList.add('flex');
            setTimeout(() => {
                $modalContent.classList.remove('scale-95', 'opacity-0');
                $modalContent.classList.add('scale-100', 'opacity-100');
            }, 50);

            // é‡ç½®æ¸¸æˆçŠ¶æ€ä»¥ä¾¿é‡æ–°å¼€å§‹
            gameState.level = 1;
            gameState.sequenceLength = INITIAL_SEQUENCE_LENGTH;
            gameState.displayTime = INITIAL_DISPLAY_TIME;
            updateUI();
            
            $statusMessage.classList.add('hidden');
            $startButton.classList.remove('hidden');
            $startButton.textContent = 'é‡æ–°å¼€å§‹æ¸¸æˆ';
            $messageText.textContent = 'ç‚¹å‡»â€œé‡æ–°å¼€å§‹æ¸¸æˆâ€å†æ¬¡æŒ‘æˆ˜ï¼';
            $instructions.classList.add('hidden');
        }
        
        /**
         * Closes the game over modal and resets the game to the initial state.
         */
        function resetGame() {
            $modalContent.classList.remove('scale-100', 'opacity-100');
            $modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                $gameOverModal.classList.add('hidden');
                $gameOverModal.classList.remove('flex');
            }, 300);
            
            // ç¡®ä¿UIå›åˆ°åˆå§‹çŠ¶æ€
            $levelDisplay.textContent = '1';
            $timerDisplay.textContent = '0s';
            $sequenceDisplay.innerHTML = '';
            $messageText.textContent = 'ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€æŒ‘æˆ˜ä½ çš„è®°å¿†åŠ›ï¼';
            $inputButtons.innerHTML = '';
            $startButton.textContent = 'å¼€å§‹æ¸¸æˆ';
            $startButton.disabled = false;
        }


        // --- Event Listeners and Initialization ---

        $startButton.addEventListener('click', startGame);
        $restartButton.addEventListener('click', resetGame);
        
        // ç¡®ä¿ DOM åŠ è½½å®Œæ¯•åå†æ‰§è¡Œåˆå§‹åŒ–
        window.onload = function() {
            // Initial setup
            updateUI();
            // åˆå§‹åŒ–æ—¶ï¼Œç”Ÿæˆä¸€æ¬¡è¾“å…¥æŒ‰é’®ï¼ˆä½¿ç”¨æ‰€æœ‰å…ƒç´ ä½œä¸ºæ½œåœ¨é€‰é¡¹ï¼‰
            renderInputButtons(EMOJIS); 
            toggleInputButtons(false);
            
            // åˆå§‹åŒ– Firebase å’Œè®¤è¯
            firebaseSetup();
        }

        // --- Firebase Debugging ---
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('debug'); // å–æ¶ˆæ³¨é‡Šä»¥æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„è°ƒè¯•æ—¥å¿—


    </script>
</body>
</html>
